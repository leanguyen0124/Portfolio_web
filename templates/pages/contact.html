<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Contact</title>
    <style>
        body { background-color: #000 !important; color: white; font-family: Arial, sans-serif; overflow-x: hidden; }
        .full-screen-container { width: 100%; min-height: 100vh; padding-top: 70px; padding-bottom: 50px; }
        .contact-wrapper { display: flex; width: 98%; margin: 0 auto; gap: 20px; }
        .contact-info-section { flex: 2.5; display: flex; flex-direction: column; gap: 20px; }
        .contact-form-section { flex: 0.7; background-color: rgba(255, 255, 255, 0.03); padding: 25px; border-radius: 10px; border: 1px solid #333; height: fit-content; position: sticky; top: 80px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; color: #aaa; }
        .form-control { width: 100%; padding: 10px; background: #111; border: 1px solid #333; color: white; border-radius: 4px; font-size: 13px; }
        .btn-preview { background: transparent; border: 1px solid #a855f7; color: #a855f7; padding: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .btn-submit { background: #a855f7; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; width: 100%; }
        
        /* Dashboard Styles */
        .preview-box { background: #0a0a0a; border: 1px solid #222; padding: 25px; border-radius: 5px; }
        .row-1 { display: flex; align-items: center; gap: 30px; border-bottom: 1px solid #222; padding-bottom: 20px; }
        .kpi-area { flex: 2; display: flex; gap: 15px; justify-content: flex-end; flex-wrap: wrap; }
        .kpi-mini-card { background: #161616; padding: 10px; border-radius: 4px; border: 1px solid #333; min-width: 120px; text-align: center; }
        .chart-row { display: flex; gap: 20px; width: 100%; margin-top: 20px; }
        .chart-card { flex: 1; background: #161616; border: 1px solid #333; border-radius: 8px; padding: 15px; height: 300px; display: flex; flex-direction: column; }
        .chart-body { flex-grow: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .chart-body img { width: 100%; height: 100%; object-fit: contain; }
        
        /* Field Tags */
        .field-tag { display: inline-block; background: #333; padding: 5px 10px; border-radius: 15px; margin: 5px; font-size: 12px; border: 1px solid #555; }
    </style>
</head>
<body>
    {% include 'base/navbar.html' %}
    <div class="full-screen-container">
        <div class="contact-wrapper">
            <div class="contact-info-section">
                <h2>Contact & Preview</h2>
                
                {% if show_preview %}
                <div class="preview-box">
                    <div class="row-1">
                        <h1 style="color:#a855f7">{{ form_data.get('dashboard_name', 'DASHBOARD') }}</h1>
                        <div class="kpi-area">
                            {% for kpi in form_data.get('kpis') %}<div class="kpi-mini-card"><div style="color:#666; font-size:10px;">{{ kpi }}</div><div style="font-size:18px;">1,234</div></div>{% endfor %}
                        </div>
                    </div>
                    <!-- HÀNG 2 & 3: CHARTS -->
                    <div class="charts-rows-container">
                        {% set img_map = {
                            'Area Chart': 'Area.png',
                            'Bar Chart': 'BarChart.jpg',
                            'Box Plot': 'BoxPlot.png',
                            'Bubble Chart': 'Bubble.png',
                            'Candle Stick': 'Candle.png',
                            'Density Plot': 'Density.png',
                            'Heatmap': 'Heatmap.png',
                            'Histogram': 'Hist.png',
                            'Line Chart': 'Line.png',
                            'Lollipop Chart': 'LolipopChart.png',
                            'Parallel Coordinates': 'Parralel.png',
                            'Pie Chart': 'Pie.png',
                            'Radar Chart': 'Radar.png',
                            'Scatter Plot': 'Scatter.png',
                            'Sunburst Chart': 'Sunburst.png',
                            'Tree Map': 'Tree.png',
                            'Waterfall Chart': 'Waterfall.png'
                        } %}

                        <!-- Hàng 2 (Top) -->
                        <div class="chart-row">
                            {% for chart in charts_top %}
                            <div class="chart-card">
                                <div class="chart-card-head">
                                    <strong>{{ chart.desc }}</strong>
                                    <span style="color:#a855f7">{{ chart.type }}</span>
                                </div>
                                <div class="chart-body">
                                    <img src="{{ url_for('static', filename='charts/' + img_map.get(chart.type, 'BarChart.jpg')) }}" 
                                         alt="{{ chart.type }}"
                                         onerror="this.style.display='none'; this.parentElement.innerHTML='⚠️ Image Not Found';"
                                    >
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Hàng 3 (Bottom) -->
                        <div class="chart-row">
                            {% for chart in charts_bottom %}
                            <div class="chart-card">
                                <div class="chart-card-head">
                                    <strong>{{ chart.desc }}</strong>
                                    <span style="color:#a855f7">{{ chart.type }}</span>
                                </div>
                                <div class="chart-body">
                                    <img src="{{ url_for('static', filename='charts/' + img_map.get(chart.type, 'BarChart.jpg')) }}" 
                                         alt="{{ chart.type }}"
                                         onerror="this.style.display='none'; this.parentElement.innerHTML='⚠️ Image Not Found';"
                                    >
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div style="border:1px dashed #333; height:400px; display:flex; align-items:center; justify-content:center; color:#444;">Nhấn Preview để xem Dashboard mẫu</div>
                {% endif %}
            </div>

            <div class="contact-form-section">
                {% with m = get_flashed_messages() %}{% if m %}{% for msg in m %}<div style="background:#2196F3; padding:10px; margin-bottom:10px; border-radius:4px;">{{ msg }}</div>{% endfor %}{% endif %}{% endwith %}
                <form action="{{ url_for('contact') }}" method="POST">
                    
                    <!-- Khôi phục Full Name & Email -->
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" name="fullname" class="form-control" value="{{ form_data.get('fullname', '') }}" placeholder="Your Name" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" class="form-control" value="{{ form_data.get('email', '') }}" placeholder="your@email.com" required>
                    </div>

                    <div class="form-group">
                        <label>Dashboard Name</label>
                        <input type="text" name="dashboard_name" class="form-control" value="{{ form_data.get('dashboard_name', '') }}" required>
                    </div>

                    <div class="form-group">
                        <label>Add Data Field (Column Name)</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" name="new_field_name" class="form-control" placeholder="E.g: Revenue">
                            <!-- Thêm formnovalidate để không bắt buộc nhập name/email khi thêm trường -->
                            <button type="submit" name="action" value="add_field" formnovalidate style="background:#333; color:white; border:1px solid #555; padding:0 15px; border-radius:4px; cursor:pointer;">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Selected Fields:</label>
                        <div style="background:#111; padding:10px; border-radius:4px; border:1px solid #222; min-height:50px;">
                            {% for field in form_data.get('fields', []) %}
                                <span class="field-tag">{{ field }}</span>
                                <input type="hidden" name="fields[]" value="{{ field }}">
                            {% endfor %}
                        </div>
                    </div>

                    <button type="submit" name="action" value="suggest_ai" class="btn-preview" style="background:linear-gradient(45deg, #a855f7, #ec4899); color:white; border:none;" formnovalidate>✨ AI SUGGEST</button>

                    <!-- KHÔI PHỤC: Khu vực hiển thị kết quả AI / Nhập tay -->
                    <div class="form-group">
                        <label style="display:flex; justify-content:space-between;">
                            KPIs
                            <button type="submit" name="action" value="add_kpi" style="background:#333; color:white; border:1px solid #555; padding:0 8px; border-radius:4px; cursor:pointer;" formnovalidate>+</button>
                        </label>
                        <div id="kpis-container">
                            {% for kpi in form_data.get('kpis', []) %}
                            <div style="margin-bottom:5px; position:relative;">
                                <input type="text" name="kpis[]" class="form-control" value="{{ kpi }}">
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display:flex; justify-content:space-between;">
                            Charts
                            <button type="submit" name="action" value="add_chart" style="background:#333; color:white; border:1px solid #555; padding:0 8px; border-radius:4px; cursor:pointer;" formnovalidate>+</button>
                        </label>
                        <div id="graphs-container">
                            {% for desc in form_data.get('graph_descs', []) %}
                            <div style="background:#111; padding:8px; margin-bottom:8px; border-radius:4px; border:1px solid #222;">
                                <input type="text" name="graph_desc[]" class="form-control" value="{{ desc }}" style="margin-bottom:5px;">
                                <select name="graph_type[]" class="form-control">
                                    {% set current_type = form_data['graph_types'][loop.index0] if loop.index0 < form_data['graph_types']|length else '' %}
                                    {% for t in ['Bar Chart', 'Line Chart', 'Pie Chart', 'Scatter Plot', 'Heatmap', 'Area Chart', 'Box Plot', 'Bubble Chart', 'Candle Stick', 'Density Plot', 'Histogram', 'Lollipop Chart', 'Parallel Coordinates', 'Radar Chart', 'Sunburst Chart', 'Tree Map', 'Waterfall Chart'] %}
                                        <option value="{{ t }}" {{ 'selected' if t == current_type else '' }}>{{ t }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <!-- HẾT KHU VỰC KHÔI PHỤC -->

                    <button type="submit" name="action" value="preview" class="btn-preview">PREVIEW DASHBOARD</button>
                    <button type="submit" name="action" value="send" class="btn-submit">SEND</button>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
